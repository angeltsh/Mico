<!DOCTYPE html>
<html ng-app="ionicApp">
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width" />
<title>MiCOKit08</title>
<link href="//code.ionicframework.com/1.0.0-beta.13/css/ionic.css" rel="stylesheet">
<script src="./js/jquery-2.1.3.js"></script>

<style>
#debug {
	margin-top:44px;
	background-color: white;
	height: 300px;
	overflow: scroll;
	color: black;
	font-size: 12px;
}
#debug p {
	padding: 3px 5px;
	word-wrap: break-word;
}
.gray {
	background-color: #ddd;
}
#debug span {
	display: block;
	word-wrap: break-word;
	margin-bottom: 2px;
}
table {
	width:100%;
	text-align:center;
}
a {
	display:inline-block;
}
.menu tr td {
	width:50%;
}
.menu tr td a {
	max-width:35%;
}
.menu tr td a img {
	width:100%;
}
.control img {
	width:100%;
}
</style>
</head>
<body>
<div id="debug" style="display:none;">
  <!--通信交互区域，保留debug标签-->
</div>
<table class="menu">
  <tr style="height:300px;">
    <td style="padding-top:15px;"><a id="led_start"><img src="image/menu/start.png" ></a><br/>
      <a id="led_pause" style="margin-right:15px;"><img src="image/menu/pause.png"  ></a><a id="led_stop"><img src="image/menu/stop.png" ></a></td>
    <td><p>左头：<span id="tempid1"></span>℃</p>
      <p>右头：<span id="tempid2"></span>℃</p>
      <p>底板：<span id="tempid3"></span>℃</p>
      <p>时间：<span id="tempid4"></span></p></td>
  </tr>
</table>
<div class="bar-footer" style="bottom:0;position:absolute;width:100%">
  <table class="control">
    <tr>
      <td><a id="led_blue"><img src="image/menu/menu.jpg"></a></td>
      <td><a id="led_green"><img src="image/menu/file.jpg"></a></td>
    </tr>
    <tr>
      <td><a id="led_red"><img src="image/menu/help.jpg"></a></td>
      <td><a id="led_switch"><img src="image/menu/switch.jpg"></a></td>
    </tr>
  </table>
</div>
</body>
<script src="http://api.easylink.io/assets/js/mqttws31.js"></script>
<script src="./js/crc.js"></script>
<script>
	var switch_btn_off=true;
    // 从url中获取某个参数的值
    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
    // 得到设备ID
    var device_id = getParameterByName('device_id');
    // 如果设备ID不为空，则执行连接MQTT的操作
    if ( device_id !== null ){
        ez_connect(device_id);
    }

    // function dump_obj(myObject) {
    //     var s = '';
    //     for (var property in myObject) {
    //         s += '<span>' + property +": " + myObject[property] + '</span>';
    //     }
    //     return s;
    // }

    // 连接MQTT服务
    function ez_connect(device_id) {
        // 获取access_token
        // access_token是公众号的全局唯一票据，公众号调用各接口时都需使用access_token。
        // 正常情况下access_token有效期为7200秒，重复获取将导致上次获取的access_token失效
        var access_token = getParameterByName('access_token');


       // document.getElementById('device_id').innerHTML = device_id;
		document.title=device_id;

        // websocket连接
        // wsbroker:host
        // wsport:端口 默认1983
        // Client-ID ： v1_web_[MAC]  //版本号_app_手机MAC(必须是12位小写)
        var wsbroker = "api.easylink.io";  //mqtt websocket enabled broker
        var wsport = 1983 // port for above
        var client = new Paho.MQTT.Client(wsbroker, wsport, "v1-web-" + parseInt(Math.random() * 1000000, 12));

        // 基本参数配置
        // 连接丢失所对应的callback函数
        client.onConnectionLost = onConnectionLost;
        // 消息到达所对应的callback函数
        client.onMessageArrived = onMessageArrived;
        // 连接成功所对应的callback函数
        client.connect({onSuccess:onConnect});

        // 连接成功
        function onConnect() {
            var subtopic = device_id+'/out/#';
            // Once a connection has been made, make a subscription and send a message.
            // 向某个通道发送指令
            // topic：通道
            // commond：指令
            client.publish = function(topic, commond) {
                console.log("现在执行-->:"+commond);
                message = new Paho.MQTT.Message(commond);
                message.destinationName = topic;
                client.send(message);
            }
            console.log("device_id:"+device_id);
            console.log("onConnect");
            client.subscribe(subtopic, {qos: 0});
        }
        // 连接丢失
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0)
                console.log("onConnectionLost:"+responseObject.errorMessage);
        }
        // 消息到达
        function onMessageArrived(message) {
	     	console.log(message.topic + ': ' +  message.payloadString);
			
			value=message.payloadString.substr(37+6,4);
			
			if(value == "D503810000C9"){
				document.getElementById("tempid4").innerHTML="OK";
			}else{
				send2uart("D50212007D",true);
				document.getElementById("tempid4").innerHTML=value;
			}
			
			
			
			//var value=parseInt(revert(message.payloadString.substr(37+6,4)),16);	
			//document.getElementById("tempid4").innerHTML=value;
			
			
			
        }

        // 串口数据发送部分
        //var inputMessage = document.getElementById('message');
        // 将消息发送到指定的通道
        function send2uart(commond,isCRCstr) {
            //if ( inputMessage.value.length == 0 ) return;
            var topic = device_id+'/in';
            //var commond = inputMessage.value;
			//console.log(commond);
			
			commond=getCRCCommond(commond,isCRCstr);
			console.log(commond);
            client.publish(topic, access_token+":"+commond);
            //inputMessage.value = '';
        }
		
		//组合CRC的指令
		function getCRCCommond(commond,isCRCstr){
			if(!isCRCstr){
				var crc=getTheCRC(commond.substr(4));
				commond=commond+crc;
			}
			return commond;
		}
		
		//高低换位
		function revert(initstr){
			return initstr.substr(2,2)+initstr.substr(0,2);
		}
	
		var commond="D50107";
		document.querySelector('#led_switch').addEventListener('click', function(){send2uart(commond,false)});
				
		var commond2="D5030A0002";
		document.querySelector('#led_blue').addEventListener('click', function(){send2uart(commond2,false)});
		
		var commond3="D502120123";
		document.querySelector('#led_green').addEventListener('click', function(){send2uart(commond3,true)});
		
		var commond4="D5030A0102";
		document.querySelector('#led_red').addEventListener('click', function(){send2uart(commond4,false)});
		
    }

    // 日志打印在页面的部分    
    var i = 0;
    console.log = (function(old_funct, div_log) {
        return function(text) {
            old_funct(text);
            var p = '';
            if (i%2 == 0)
                p = '<p>';
            else
                p = '<p class=\'gray\'>';

            if (typeof text === "object")
                div_log.innerHTML += p + JSON.stringify(text) + '</p>';
            else
                div_log.innerHTML += p + text + '</p>';

            div_log.scrollTop = div_log.scrollHeight;
            i += 1;
        };
    } (console.log.bind(console), document.getElementById("debug")));
    console.error = console.debug = console.info =  console.log;
</script>
</html>
